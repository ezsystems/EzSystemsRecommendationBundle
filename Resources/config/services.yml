services:
    ez_recommendation.client.yoochoose_notifier:
        class: 'EzSystems\RecommendationBundle\Client\YooChooseNotifier'
        arguments:
            - '@ez_recommendation.client.yoochoose_notifier.guzzle_client'
            - '@ezpublish.api.repository'
            - '@ezpublish.api.service.content'
            - '@ezpublish.api.service.location'
            - '@ezpublish.api.service.content_type'
            - {api-endpoint: '%ez_recommendation.api_endpoint%'}
            - '@?logger'
        calls:
            - [setCustomerId, ['$yoochoose.customer_id;ez_recommendation$']]
            - [setLicenseKey, ['$yoochoose.license_key;ez_recommendation$']]
            - [setServerUri, ['$server_uri;ez_recommendation$']]
            - [setIncludedContentTypes, ['$recommender.included_content_types;ez_recommendation$']]
        tags:
            - { name: monolog.logger, channel: ez_recommendation }

    ez_recommendation.client.yoochoose_notifier.guzzle_client:
        class: GuzzleHttp\Client
        arguments:
            - { base_url: '%ez_recommendation.api_endpoint%' }

  # The configured eZ Publish Platform legacy search engine - enable lines below only if you're using legacy bridge.

#    ez_recommendation.legacy.search_engine:
#        class: ezpSearchEngine
#        factory_class: EzSystems\RecommendationBundle\eZ\Publish\LegacySearch\LegacySearchFactory
#        factory_method: build
#        arguments: ["@ezpublish_legacy.kernel"]
#
#    ez_recommendation.legacy.recommendation_search_engine:
#        class: EzSystems\RecommendationBundle\eZ\Publish\LegacySearch\RecommendationLegacySearchEngine
#        arguments:
#            - "@ez_recommendation.client.yoochoose_notifier"
#            - "@ez_recommendation.legacy.search_engine"
#
#    ez_recommendation.legacy.search_configuration_mapper:
#        class: EzSystems\RecommendationBundle\eZ\Publish\LegacySearch\ConfigurationMapper
#        arguments:
#            - "@ez_recommendation.legacy.recommendation_search_engine"
#            - "@ezpublish.siteaccess"
#        tags:
#            - { name: kernel.event_subscriber }

    ez_recommendation.twig.extension:
        class: 'EzSystems\RecommendationBundle\Twig\RecommendationTwigExtension'
        public: true
        arguments:
            - '@request_stack'
            - '@ezpublish.api.service.content_type'
            - '@ezpublish.api.service.content'
            - '@ezpublish.api.service.location'
            - '@ezpublish.api.service.user'
            - '@ezpublish.locale.converter'
            - '@security.authorization_checker'
            - '@security.token_storage'
            - '@session'
            - recommenderEndPoint: '%ez_recommendation.recommender.api_endpoint%'
              consumeTimeout: '%ez_recommendation.recommender.consume_timeout%'
              trackingScriptUrl: '%ez_recommendation.tracking.script_url%'
              trackingEndPoint: '%ez_recommendation.tracking.api_endpoint%'
        calls:
            - [setIncludedContentTypes, ['$recommender.included_content_types;ez_recommendation$']]
            - [setCustomerId, ['$yoochoose.customer_id;ez_recommendation$']]
        tags:
            - { name: twig.extension }

    ez_recommendation.event_listener.login:
        class: 'EzSystems\RecommendationBundle\EventListener\Login'
        arguments:
            - '@security.authorization_checker'
            - '@session'
            - '@ez_recommendation.client.yoochoose_notifier.guzzle_client'
            - trackingEndPoint: '%ez_recommendation.tracking.api_endpoint%'
            - '@ezpublish.api.service.user'
            - "@?logger"
        calls:
            - [setCustomerId, ['$yoochoose.customer_id;ez_recommendation$']]
        tags:
            - { name: kernel.event_listener, event: security.interactive_login, priority: 255 }
            - { name: monolog.logger, channel: ez_recommendation }

    ez_recommendation.event_listener.session_backup:
        class: 'EzSystems\RecommendationBundle\EventListener\SessionBackup'
        tags:
            - { name: kernel.event_listener, event: kernel.request, method: onKernelRequest }

    ez_recommendation.value_object_visitor.content_data:
        parent: ezpublish_rest.output.value_object_visitor.base
        class: 'EzSystems\RecommendationBundle\Rest\ValueObjectVisitor\ContentData'
        tags:
            - { name: ezpublish_rest.output.value_object_visitor, type: EzSystems\RecommendationBundle\Rest\Values\ContentData }

    ez_recommendation.export_authenticator:
        class: 'EzSystems\RecommendationBundle\Authentication\ExportAuthenticator'
        arguments:
            - '@request_stack'
            - '%kernel.root_dir%'
            - '%ez_recommendation.export.users_authentication.method%'
            - '%ez_recommendation.export.users_authentication.login%'
            - '%ez_recommendation.export.users_authentication.password%'

    ez_recommendation.export_notifier:
        class: 'EzSystems\RecommendationBundle\Client\ExportNotifier'
        arguments:
            - '@logger'
            - '%kernel.root_dir%'
        tags:
            - { name: monolog.logger, channel: ez_recommendation }

    ez_recommendation.siteaccess_helper:
        class: 'EzSystems\RecommendationBundle\Helper\SiteAccess'
        arguments:
            - '@ezpublish.config.resolver'
            - '@ezpublish.siteaccess'
            - '%ez_recommendation.siteaccess_config%'

    ez_recommendation.filesystem_helper:
        class: 'EzSystems\RecommendationBundle\Helper\FileSystem'
        arguments:
            - '@ez_recommendation.export_authenticator'

    ez_recommendation.field.relation_mapper:
        class: 'EzSystems\RecommendationBundle\Rest\Field\RelationMapper'
        arguments:
            - '%ez_recommendation.relations%'

    ez_recommendation.rest.content:
        class: 'EzSystems\RecommendationBundle\Rest\Content\Content'
        arguments:
            - '@ezpublish.urlalias_router'
            - '@ezpublish.api.service.content'
            - '@ezpublish.api.service.location'
            - '@ezpublish.api.service.content_type'
            - '@ezpublish.api.service.search'
            - '@ez_recommendation.rest.field.value'
            - '%ez_recommendation.default.author_id%'
            - '@ezpublish.config.resolver'
            - '@service_container'
            - '@router.request_context'
        calls:
            - [setSiteAccess, ['@ezpublish.siteaccess']]
            - [setCustomerId, ['$yoochoose.customer_id;ez_recommendation$']]
            - [setLicenseKey, ['$yoochoose.license_key;ez_recommendation$']]
            - [setSiteAccessConfig, ['%ez_recommendation.siteaccess_config%']]

    ez_recommendation.rest.contenttype:
        class: 'EzSystems\RecommendationBundle\Rest\Content\ContentType'
        parent: 'ez_recommendation.rest.content'
        calls:
            - [setLogger, ['@?logger']]
            - [setContentListElementGenerator, ['@ez_recommendation.rest.visitor.generator']]
            - [setExportNotifier, ['@ez_recommendation.export_notifier']]
            - [setSiteAccessHelper, ['@ez_recommendation.siteaccess_helper']]
            - [setFileSystemHelper, ['@ez_recommendation.filesystem_helper']]
        tags:
            - { name: monolog.logger, channel: ez_recommendation }

    ez_recommendation.rest.controller.content:
        class: 'EzSystems\RecommendationBundle\Rest\Controller\ContentController'
        arguments:
            - '@ez_recommendation.rest.contenttype'
            - '@ez_recommendation.export_authenticator'
        parent: ezpublish_rest.controller.base

    ez_recommendation.rest.controller.contenttype:
        class: 'EzSystems\RecommendationBundle\Rest\Controller\ContentTypeController'
        parent: ez_recommendation.rest.controller.content
        arguments:
            - '@ez_recommendation.rest.contenttype'
            - '@ez_recommendation.export_authenticator'

    ez_recommendation.rest.controller.export:
        class: 'EzSystems\RecommendationBundle\Rest\Controller\ExportController'
        arguments:
            - '@ez_recommendation.rest.contenttype'
            - '@ez_recommendation.export_authenticator'
            - '@?logger'
            - '%kernel.root_dir%'
            - '%kernel.environment%'
        tags:
            - { name: monolog.logger, channel: ez_recommendation }

    ez_recommendation.rest.field.value:
        class: 'EzSystems\RecommendationBundle\Rest\Field\Value'
        arguments:
            - '@ezpublish.api.service.content'
            - '@ezpublish.api.service.content_type'
            - '@ez_recommendation.rest.field.type_value'
            - {fieldIdentifiers: '%ez_recommendation.field_identifiers%'}
            - '@ez_recommendation.field.relation_mapper'
            - '@?logger'

    ez_recommendation.rest.field.type_value:
        class: 'EzSystems\RecommendationBundle\Rest\Field\TypeValue'
        arguments:
            - '@request_stack'
            - '@ezpublish.config.resolver.core'
            - '@ezpublish.image_alias.imagine.alias_generator'
            - '@ezpublish.fieldtype.ezrichtext.converter.output.xhtml5.core'
            - "@?ezpublish.fieldtype.ezxmltext.converter.html5"

    ez_recommendation.rest.visitor.generator:
        class: 'EzSystems\RecommendationBundle\Rest\ValueObjectVisitor\ContentListElementGenerator'

    ez_recommendation.rest.response:
        abstract: true
        arguments:
            - '@ez_recommendation.rest.visitor.generator'
            - '%ez_recommendation.export.users_authentication.method%'
            - '%ez_recommendation.export.users_authentication.login%'
            - '%ez_recommendation.export.users_authentication.password%'

    ez_recommendation.rest.response.http:
        class: 'EzSystems\RecommendationBundle\Rest\Response\HttpResponse'
        parent: ez_recommendation.rest.response
        tags:
            - { name: ez_recommendation.rest.response_type, type: http }
